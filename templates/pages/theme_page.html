{% load static %}
{% load cms_tags %}
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>{{ page.name }} - Marrakech Activities Portal</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- font awesome cdn -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" integrity="sha512-iBBXm8fW90+nuLcSKlbmrPcLa0OT92xO1BIsZ+ywDWZCvqsWgccV3gFoRBv0z+8dLJgyAHIhR35VZc2oM/gI1w==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <!-- fonts -->
    <link rel="stylesheet" href="{% static 'font/fonts.css' %}">
    <!-- normalize css -->
    <link rel="stylesheet" href="{% static 'css/normalize.css' %}">
    <!-- custom css -->
    <link rel="stylesheet" href="{% static 'css/utility.css' %}">
    <link rel="stylesheet" href="{% static 'css/theme.css' %}">
    <link rel="stylesheet" href="{% static 'css/slider.css' %}">
    <link rel="stylesheet" href="{% static 'css/form.css' %}">
    <link rel="stylesheet" href="{% static 'css/responsive.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.2/css/all.min.css" integrity="sha512-1sCRPdkRXhBV2PBLUdRb4tMg1w2YPf37qatUFeS7zlBy7jJI8Lf4VHwWfZZfpXtYSLy85pkm9GaYVYMfw5BC1A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="{% static 'css/navbar-mobile.css' %}">
    
    {% if edit_mode %}
    <!-- Edit Mode CSS -->
    <link rel="stylesheet" href="{% static 'admin/css/dashboard.css' %}">
    <style>
        /* Additional styles for the theme page edit mode */
        .slider-edit-controls {
            background-color: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .slider-edit-controls h4 {
            margin-top: 0;
            margin-bottom: 10px;
            color: #333;
        }
        
        .edit-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            padding: 8px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            background-color: white;
        }
        
        .edit-item:hover {
            background-color: #f0f0f0;
        }
        
        .edit-item img {
            width: 60px;
            height: 40px;
            object-fit: cover;
            margin-right: 10px;
        }
        
        .edit-item-buttons {
            margin-left: auto;
        }
        
        .edit-item-buttons button {
            margin-left: 5px;
        }
    </style>
    <style>
    /* Additional styles for slider management */
    .edit-controls-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }
    
    .add-slide-btn {
        background-color: #28a745;
    }
    
    .edit-item-info {
        flex: 1;
        margin-left: 15px;
    }
    
    .edit-item-details {
        margin-top: 5px;
    }
    
    .edit-item-detail {
        font-size: 13px;
        margin-bottom: 3px;
        color: #555;
    }
    
    .edit-item-detail span {
        font-weight: bold;
        color: #333;
        display: inline-block;
        width: 80px;
    }
    
    .edit-item-detail em {
        color: #999;
        font-style: italic;
    }
    
    .empty-slider-message {
        background-color: #f8f9fa;
        padding: 20px;
        text-align: center;
        border-radius: 4px;
        margin-top: 15px;
    }
    
    .dashboard-btn.danger {
        background-color: #dc3545;
    }
    
    .dashboard-btn.danger:hover {
        background-color: #c82333;
    }
    
    .edit-modal {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0,0,0,0.5);
        z-index: 1000;
        display: flex;
        justify-content: center;
        align-items: center;
    }
    
    .edit-modal-content {
        background-color: white;
        padding: 20px;
        border-radius: 5px;
        width: 80%;
        max-width: 500px;
        color: #333;
    }
    
    .edit-modal-content h3 {
        margin-top: 0;
        margin-bottom: 15px;
        color: #333;
    }
    
    .edit-modal-content .form-control {
        width: 100%;
        padding: 8px;
        margin-bottom: 15px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        color: #333;
    }
    
    .button-group {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
    }
    
    .edit-save-btn, .edit-cancel-btn {
        padding: 5px 15px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }
    
    .edit-save-btn {
        background-color: #1ec6b6;
        color: white;
    }
    
    .edit-cancel-btn {
        background-color: #6c757d;
        color: white;
    }
</style>
    {% endif %}
</head>
<body {% if edit_mode %}class="edit-mode"{% endif %}>
    {% include 'includes/navbar.html' %}
    
    {% if edit_mode %}
    <!-- Slider Edit Controls - Only visible in edit mode -->
    <div class="container slider-edit-controls">
        <h4>Edit Slider Images and Content</h4>
        <div class="edit-controls-header">
            <span>Manage your slider elements below</span>
            <button type="button" class="dashboard-btn add-slide-btn" 
                    onclick="createNewSlide('{{ page.id }}')">
                <i class="fas fa-plus"></i> Add New Slide
            </button>
        </div>
        
        {% if gallery_elements %}
            {% for element in gallery_elements %}
                <div class="edit-item" data-element-id="{{ element.id }}">
                    <img src="{{ element.src }}" alt="Slide {{ forloop.counter }}">
                    <div class="edit-item-info">
                        <strong>Slide {{ forloop.counter }}</strong>
                        <div class="edit-item-details">
                            <div class="edit-item-detail"><span>Title:</span> {{ element.title|default:"<em>Empty - Click to add</em>"|safe }}</div>
                            <div class="edit-item-detail"><span>Description:</span> {{ element.description|default:"<em>Empty - Click to add</em>"|safe }}</div>
                        </div>
                    </div>
                    <div class="edit-item-buttons">
                        <button type="button" class="dashboard-btn" 
                                onclick="editElement('image', {{ element.id }})">
                            <i class="fas fa-image"></i> Edit Image
                        </button>
                        <button type="button" class="dashboard-btn" 
                                onclick="editElement('text', {{ element.id }}, 'title')">
                            <i class="fas fa-heading"></i> Edit Title
                        </button>
                        <button type="button" class="dashboard-btn" 
                                onclick="editElement('text', {{ element.id }}, 'description')">
                            <i class="fas fa-align-left"></i> Edit Description
                        </button>
                        <button type="button" class="dashboard-btn danger" 
                                onclick="deleteSlide({{ element.id }})">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </div>
                </div>
            {% endfor %}
        {% else %}
            <div class="empty-slider-message">
                No slides found. Click "Add New Slide" to create your first slide.
            </div>
        {% endif %}
    </div>
    {% endif %}
    
    <!-- header with slider -->
    <header class="flex header-sm">
    <div class="slider-container">
        <div class="slider-list">
            {% if gallery_elements %}
                {% for element in gallery_elements %}
                    <div class="slider-item" id="item_{{ forloop.counter0 }}">
                        {% if edit_mode %}
                        <img src="{{ element.src }}" alt="{{ element.title|default:'' }}" class="{{ css_class }}">
                        {% else %}
                        {% editable_image element %}
                        {% endif %}
                        <div class="slider-content">
                            {% if element.title %}
                                <h2 class="header-title-text">{{ element.title }}</h2>
                            {% endif %}
                            
                            {% if element.description %}
                                <div class="slider-content1">
                                    {{ element.description|safe }}
                                </div>
                            {% endif %}
                            
                            <a href="https://wa.me/212643562320?text=Hello,%20I%20want%20to%20book%20a%20trip%20to%20{{ page.name|lower }}">
                                <button class="slider-button" target="_blank">Book Now</button>
                            </a>
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <!-- Default slider item if no gallery elements exist -->
                <div class="slider-item" id="item_0">
                    <img src="{% static 'images/default.jpg' %}" alt="" />
                    <div class="slider-content">
                        <h2 class="header-title-text">{{ page.name }}</h2>
                        <div class="slider-content1">
                            Discover the beauty of {{ page.name }}
                        </div>
                        <a href="https://wa.me/212643562320?text=Hello,%20I%20want%20to%20book%20a%20trip%20to%20{{ page.name|lower }}">
                            <button class="slider-button" target="_blank">Book Now</button>
                        </a>
                    </div>
                </div>
            {% endif %}
        </div>
        <button id="slider-prev" class="slider-prev"><i class="fa-solid fa-angle-left"></i></button>
        <button id="slider-next" class="slider-next"><i class="fa-solid fa-angle-right"></i></button>
    </div>
</header>
    <!-- end of header -->

    <!-- Trip Description Section -->
    <section class="trip-description">
        <div class="container">
            <div class="section-title text-center">
                <h2>{% editable_text header_element 'title' %}</h2>
                <p>{% editable_text header_element 'description' %}</p>
            </div>
            <div class="trip-details">
                <div class="trip-info">
                        <h2>{% editable_text about_trip_elements.0 'title' %}</h2>
                        <p>{% editable_text about_trip_elements.0 'description' %}</p>
                        <p></p>
                        
                        <div class="trip-highlights">
                            <h3>{% with highlight_data=about_trip_elements.0.json_content|json_parse %}{{ highlight_data.title }}{% endwith %}</h3>
                            
                            {% if edit_mode %}
                            <!-- Add prominent edit button -->
                            <button type="button" class="trip-edit-btn" onclick="openJsonEditor('{{ about_trip_elements.0.id }}')">
                                <i class="fas fa-edit"></i> Edit Trip Details
                            </button>
                            {% endif %}
                            
                            {% editable_highlights about_trip_elements.0 %}
                            <p>{% with highlight_data=about_trip_elements.0.json_content|json_parse %}{{ highlight_data.description }}{% endwith %}</p>

                            {% if about_trip_elements %}
                                {% with highlight_data=about_trip_elements.0.json_content|json_parse %}
                                    {% if highlight_data.price %}
                                        <div class="price-section">
                                            <h4>Price</h4>
                                            <p>{{ highlight_data.price }}</p>
                                        </div>
                                    {% endif %}
                                {% endwith %}
                            {% endif %}
                        </div>
                        
                    
                    
                </div>
                
                <div class="booking-form">
                        <h3>{% editable_text booking_elements.0 'title' %}</h3>
                        {% editable_form booking_elements.0 %}
                </div>
            </div>
        </div> 
    </section>

    {% include 'includes/footer.html' %}
    
    <!-- JavaScript -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="{% static 'js/script.js' %}"></script>
    <script src="{% static 'js/slider.js' %}"></script>
    
    {% if edit_mode %}
    <!-- Edit Mode JavaScript -->
    <script src="{% static 'admin/js/edit-mode.js' %}"></script>
    <script>
    // Function to handle element editing
    function editElement(type, elementId, field = '') {
        if (type === 'image') {
            // Open image upload modal
            openImageUploadModal(elementId);
        } else if (type === 'text') {
            // Open text edit modal
            openTextEditModal(elementId, field);
        }
    }
    
    // These functions should be defined in edit-mode.js
    // If they're not, we can add them here as placeholders
    function openImageUploadModal(elementId) {
        if (typeof window.openImageEditor === 'function') {
            window.openImageEditor(elementId);
        } else {
            console.log('Opening image upload for element ID:', elementId);
            // Fallback implementation if the function doesn't exist
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = 'image/*';
            fileInput.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    const formData = new FormData();
                    formData.append('image', file);
                    
                    fetch(`/dashboard/element/${elementId}/upload-image/`, {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-CSRFToken': getCookie('csrftoken')
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            showNotification('Image updated successfully', 'success');
                            setTimeout(() => {
                                window.location.reload();
                            }, 1000);
                        } else {
                            showNotification('Error updating image', 'error');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        showNotification('Error updating image', 'error');
                    });
                }
            };
            fileInput.click();
        }
    }
    
    function openTextEditModal(elementId, field) {
        if (typeof window.openTextEditor === 'function') {
            window.openTextEditor(elementId, field);
        } else {
            console.log('Opening text editor for element ID:', elementId, 'field:', field);
            
            // Fetch current content
            fetch(`/dashboard/element/${elementId}/get/`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Server returned ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                // Extract the correct content based on the field
                let content = '';
                if (field === 'title') {
                    content = data.title || '';
                } else if (field === 'description') {
                    content = data.description || '';
                }
                
                // Create modal for editing
                const modal = document.createElement('div');
                modal.className = 'edit-modal';
                modal.innerHTML = `
                    <div class="edit-modal-content">
                        <h3>Edit ${field === 'title' ? 'Title' : 'Description'}</h3>
                        ${field === 'description' ? 
                            `<textarea class="form-control" style="min-height:150px; color:#333;">${content}</textarea>` : 
                            `<input type="text" class="form-control" value="${content}" style="color:#333;">`
                        }
                        <div class="button-group">
                            <button class="edit-save-btn">Save</button>
                            <button class="edit-cancel-btn">Cancel</button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // Focus the input/textarea
                const input = field === 'description' ? 
                    modal.querySelector('textarea') : 
                    modal.querySelector('input');
                input.focus();
                
                // Cancel button handler
                modal.querySelector('.edit-cancel-btn').addEventListener('click', () => {
                    document.body.removeChild(modal);
                });
                
                // Save button handler
                modal.querySelector('.edit-save-btn').addEventListener('click', () => {
                    const newContent = input.value;
                    
                    const formData = new FormData();
                    formData.append('field', field);
                    formData.append('value', newContent);
                    
                    fetch(`/dashboard/element/${elementId}/update/`, {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-CSRFToken': getCookie('csrftoken')
                        }
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`Server returned ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.success) {
                            showNotification('Content updated successfully', 'success');
                            
                            // Update the displayed value in the edit controls
                            const detailElement = document.querySelector(`.edit-item[data-element-id="${elementId}"] .edit-item-detail:nth-child(${field === 'title' ? '1' : '2'})`);
                            if (detailElement) {
                                const spanElement = detailElement.querySelector('span');
                                detailElement.innerHTML = '';
                                detailElement.appendChild(spanElement);
                                detailElement.innerHTML += newContent.length > 0 ? newContent : '<em>Empty - Click to add</em>';
                            }
                            
                            setTimeout(() => {
                                window.location.reload();
                            }, 1000);
                        } else {
                            showNotification(data.message || 'Error updating content', 'error');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        showNotification('Error updating content: ' + error.message, 'error');
                    })
                    .finally(() => {
                        document.body.removeChild(modal);
                    });
                });
            })
            .catch(error => {
                console.error('Error fetching element data:', error);
                showNotification('Error fetching content: ' + error.message, 'error');
            });
        }
    }
    
    function showNotification(message, type) {
        // Create notification element
        const notification = document.createElement('div');
        notification.className = `edit-notification edit-notification-${type}`;
        notification.textContent = message;
        
        // Add to document
        document.body.appendChild(notification);
        
        // Remove after delay
        setTimeout(() => {
            notification.classList.add('fade-out');
            setTimeout(() => {
                document.body.removeChild(notification);
            }, 500);
        }, 3000);
    }
    
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    // Function to create a new slide
    function createNewSlide(pageId) {
        // Show confirmation dialog
        if (!confirm("Create a new slide?")) {
            return;
        }
        
        // Create FormData for the request
        const formData = new FormData();
        formData.append('action', 'add_element');
        formData.append('title', '');
        formData.append('description', '');
        formData.append('src', '/static/images/default.jpg');
        formData.append('order', '0');
        
        // Use the gallery section ID defined at the bottom of the file
        const sectionId = GALLERY_SECTION_ID;
        
        if (!sectionId) {
            showNotification('Error: Could not find the gallery section', 'error');
            return;
        }
        
        // Send request to create a new element
        fetch(`/dashboard/section/${sectionId}/edit/`, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            // Instead of parsing JSON, we're expecting a redirect
            showNotification('Slide created successfully!');
            // Reload the page after a short delay
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        })
        .catch(error => {
            console.error('Error creating slide:', error);
            showNotification('Error creating slide: ' + error.message, 'error');
        });
    }
    
    // Function to delete a slide
    function deleteSlide(elementId) {
        // Show confirmation dialog
        if (!confirm("Are you sure you want to delete this slide? This action cannot be undone.")) {
            return;
        }
        
        // Check if we have a CSRF token
        const csrftoken = getCookie('csrftoken');
        if (!csrftoken) {
            showNotification('Error: CSRF token not found', 'error');
            return;
        }
        
        // Create FormData for the request
        const formData = new FormData();
        formData.append('action', 'delete_element');
        
        // Send request to delete the element
        fetch(`/dashboard/element/${elementId}/delete/`, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': csrftoken
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`Server returned ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                showNotification('Slide deleted successfully!');
                
                // Remove the slide from the DOM
                const slideElement = document.querySelector(`.edit-item[data-element-id="${elementId}"]`);
                if (slideElement) {
                    slideElement.remove();
                }
                
                // Reload the page after a short delay
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } else {
                throw new Error(data.message || 'Unknown error');
            }
        })
        .catch(error => {
            console.error('Error deleting slide:', error);
            showNotification('Error deleting slide: ' + error.message, 'error');
        });
    }
    
    // Enhance the existing openTextEditModal function to handle empty values
    function openTextEditModal(elementId, field) {
        if (typeof window.openTextEditor === 'function') {
            window.openTextEditor(elementId, field);
        } else {
            console.log('Opening text editor for element ID:', elementId, 'field:', field);
            
            // Fetch current content
            fetch(`/dashboard/element/${elementId}/get/`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Server returned ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                // Extract the correct content based on the field
                let content = '';
                if (field === 'title') {
                    content = data.title || '';
                } else if (field === 'description') {
                    content = data.description || '';
                }
                
                // Create modal for editing
                const modal = document.createElement('div');
                modal.className = 'edit-modal';
                modal.innerHTML = `
                    <div class="edit-modal-content">
                        <h3>Edit ${field === 'title' ? 'Title' : 'Description'}</h3>
                        ${field === 'description' ? 
                            `<textarea class="form-control" style="min-height:150px; color:#333;">${content}</textarea>` : 
                            `<input type="text" class="form-control" value="${content}" style="color:#333;">`
                        }
                        <div class="button-group">
                            <button class="edit-save-btn">Save</button>
                            <button class="edit-cancel-btn">Cancel</button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // Focus the input/textarea
                const input = field === 'description' ? 
                    modal.querySelector('textarea') : 
                    modal.querySelector('input');
                input.focus();
                
                // Cancel button handler
                modal.querySelector('.edit-cancel-btn').addEventListener('click', () => {
                    document.body.removeChild(modal);
                });
                
                // Save button handler
                modal.querySelector('.edit-save-btn').addEventListener('click', () => {
                    const newContent = input.value;
                    
                    const formData = new FormData();
                    formData.append('field', field);
                    formData.append('value', newContent);
                    
                    fetch(`/dashboard/element/${elementId}/update/`, {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-CSRFToken': getCookie('csrftoken')
                        }
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`Server returned ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.success) {
                            showNotification('Content updated successfully', 'success');
                            
                            // Update the displayed value in the edit controls
                            const detailElement = document.querySelector(`.edit-item[data-element-id="${elementId}"] .edit-item-detail:nth-child(${field === 'title' ? '1' : '2'})`);
                            if (detailElement) {
                                const spanElement = detailElement.querySelector('span');
                                detailElement.innerHTML = '';
                                detailElement.appendChild(spanElement);
                                detailElement.innerHTML += newContent.length > 0 ? newContent : '<em>Empty - Click to add</em>';
                            }
                            
                            setTimeout(() => {
                                window.location.reload();
                            }, 1000);
                        } else {
                            showNotification(data.message || 'Error updating content', 'error');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        showNotification('Error updating content: ' + error.message, 'error');
                    })
                    .finally(() => {
                        document.body.removeChild(modal);
                    });
                });
            })
            .catch(error => {
                console.error('Error fetching element data:', error);
                showNotification('Error fetching content: ' + error.message, 'error');
            });
        }
    }
    </script>
    {% endif %}

    {% comment %}Let's get the gallery section ID and output it as a JavaScript variable{% endcomment %}
    <script>
        // Define gallery section ID variable
        let GALLERY_SECTION_ID = null;
        {% for section in page.sections.all %}
            {% if section.name == 'gallery' %}
                GALLERY_SECTION_ID = {{ section.id }};
            {% endif %}
        {% endfor %}
    </script>
</body>
</html>
