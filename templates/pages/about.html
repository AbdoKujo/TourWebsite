{% extends 'base.html' %}
{% load static %}
{% load cms_tags %}

{% block title %}Services - Marrakech Activities Portal{% endblock %}

{% block content %}
<!-- header -->
<header class="flex header-sm" id="header-section">
    {% if header_element %}
    <div class="header-bg" style="display: none;">
        {% editable_image header_element 'header-bg-img' %}
    </div>
    {% endif %}
    
    <div class="container">
        <div class="header-title">
            <h1>{% editable_text header_element 'title' %}</h1>
            <p>{% editable_text header_element 'description' %}</p>
        </div>
    </div>
</header>
<!-- header -->

<!-- services section -->
<section>
        {% for element in about_elements %}
            {% with link_data=element.json_content|json_parse %}
            <div class="tour-container">
                {% editable_image element %}
                <div class="tour-details">
                    <h2>{% editable_text element 'title' %}</h2>
                    <p>{% editable_text element 'description' %}</p>
                    
                    <!-- Modified read more button with edit button -->
                    <div class="read-more-container">
                        <a href="{% url 'theme_page' link_data.link|cut:'theme/' %}" class="read-more-btn">{{ link_data.link_text }}</a>
                        
                        {% if edit_mode %}
                        <button type="button" class="edit-link-btn" 
                                onclick="editLinkData('{{ element.id }}', '{{ link_data.link_text|escapejs }}', '{{ link_data.link|escapejs }}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endwith %}
        {% endfor %}
</section>
<!-- end of services section -->

<!-- facts section -->
<section id="facts" class="py-4 flex">
    <div class="container">
        <div class="title-wrap">
            <span class="sm-title">
                    {% for element in facts_elements %}
                        {% with parsed=element.json_content|json_parse %}
                            {% if parsed.type == 'subtitle' %}
                                {% editable_text element 'title' %}
                            {% endif %}
                        {% endwith %}
                    {% endfor %}
            </span>
            <h2 class="lg-title">
                    {% for element in facts_elements %}
                        {% with parsed=element.json_content|json_parse %}
                            {% if parsed.type == 'title' %}
                                {% editable_text element 'title' %}
                            {% endif %}
                        {% endwith %}
                    {% endfor %}

            </h2>
        </div>

        {% for element in facts_elements %}
            {% with parsed=element.json_content|json_parse %}
                {% if not parsed.type %}
                    <div class="facts-row" data-editable="json" data-element-id="{{ element.id }}">
                        {% for item in parsed.items %}
                        <div class="facts-item">
                            <span class="{{ item.icon }} facts-icon"></span>
                            <div class="facts-info">
                                <strong>{{ item.title }}</strong>
                                <p class="text">{{ item.text }}</p>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% endif %}
            {% endwith %}
        {% endfor %}
    </div>
</section>
<!-- end of facts section -->

{% if edit_mode %}
<script>
    function editLinkData(elementId, currentText, currentLink) {
        // Create modal
        const modal = document.createElement('div');
        modal.className = 'edit-modal';
        modal.innerHTML = `
            <div class="edit-modal-content">
                <h3>Edit Read More Link</h3>
                <div class="form-group">
                    <label for="link-text">Button Text</label>
                    <input type="text" id="link-text" value="${currentText}" class="form-control">
                </div>
                <div class="form-group">
                    <label for="link-url">Link URL (format: theme/page-slug)</label>
                    <input type="text" id="link-url" value="${currentLink}" class="form-control">
                </div>
                <div class="button-group">
                    <button class="edit-save-btn">Save</button>
                    <button class="edit-cancel-btn">Cancel</button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        
        // Handle save button
        modal.querySelector('.edit-save-btn').addEventListener('click', function() {
            const linkText = modal.querySelector('#link-text').value.trim();
            const linkUrl = modal.querySelector('#link-url').value.trim();
            
            if (linkText && linkUrl) {
                const linkData = {
                    link_text: linkText,
                    link: linkUrl
                };
                
                // Save the JSON data
                const formData = new FormData();
                formData.append('field', 'json_content');
                formData.append('value', JSON.stringify(linkData));
                
                fetch(`/dashboard/element/${elementId}/update/`, {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showNotification('Link updated successfully');
                        setTimeout(() => location.reload(), 1000);
                    } else {
                        showNotification('Error updating link', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showNotification('Error updating link', 'error');
                });
            }
            
            document.body.removeChild(modal);
        });
        
        // Handle cancel button
        modal.querySelector('.edit-cancel-btn').addEventListener('click', function() {
            document.body.removeChild(modal);
        });
    }
</script>
{% endif %}

{% endblock %}
